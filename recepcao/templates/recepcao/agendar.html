{% extends 'usuarios/base.html' %}

{% block title %}Agendar Paciente{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="fw-bold text-center mb-4">
                    <i class="bi bi-calendar-plus text-success"></i>
                    Agendar Paciente
                </h4>

                <!-- ===================== -->
                <!-- ERROS GERAIS DO FORM -->
                <!-- ===================== -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" id="formAgendamento">
                    {% csrf_token %}
                    {{ form.paciente }}  <!-- campo oculto -->

                    <!-- BUSCA PACIENTE -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Buscar Paciente</label>
                        <input type="text" id="buscaPaciente" class="form-control" placeholder="Digite nome, CPF ou data nascimento">
                        <div id="resultadoBusca" class="list-group mt-2"></div>
                    </div>

                    <!-- DATA -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Data</label>
                        {{ form.data }}
                        {% if form.data.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.data.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- HORA -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Hora</label>
                        {{ form.hora }}
                        {% if form.hora.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.hora.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'recepcao_dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>

                        <button type="submit" class="btn btn-success" id="btnSubmit">
                            <i class="bi bi-check-circle"></i> Confirmar Agendamento
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // ===========================
    // DATA AUTOMÁTICA (TRAVADA)
    // ===========================
    const inputData = document.getElementById("id_data");
    if (inputData && !inputData.value) {
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const ano = hoje.getFullYear();
        inputData.value = `${ano}-${mes}-${dia}`;
    }
    if (inputData) inputData.readOnly = true;

    // ===========================
    // HORA AUTOMÁTICA (TRAVADA)
    // ===========================
    const inputHora = document.getElementById("id_hora");
    if (inputHora && !inputHora.value) {
        const agora = new Date();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        inputHora.value = `${horas}:${minutos}`;
    }
    if (inputHora) inputHora.readOnly = true;

    // ===========================
    // AUTOCOMPLETE PACIENTE
    // ===========================
    const input = document.getElementById("buscaPaciente");
    const resultado = document.getElementById("resultadoBusca");
    const hiddenPaciente = document.getElementById("id_paciente");

    input.addEventListener("keyup", function() {
        let query = this.value.trim();
        if (query.length < 2) {
            resultado.innerHTML = "";
            return;
        }

        fetch(`/recepcao/buscar-paciente/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultado.innerHTML = "";
                data.forEach(paciente => {
                    let item = document.createElement("a");
                    item.classList.add("list-group-item", "list-group-item-action");
                    item.style.cursor = "pointer";

                    function highlight(text, term) {
                        const regex = new RegExp(`(${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, "gi");
                        return text.replace(regex, "<strong>$1</strong>");
                    }

                    item.innerHTML = `${highlight(paciente.nome, query)} | CPF: ${highlight(paciente.cpf, query)} | Nasc: ${highlight(paciente.data_nascimento, query)}`;
                    item.onclick = function() {
                        input.value = paciente.nome;
                        hiddenPaciente.value = paciente.id;
                        resultado.innerHTML = "";
                    };

                    resultado.appendChild(item);
                });
            });
    });

    // ===========================
    // EVITAR CLIQUES DUPLOS
    // ===========================
    const form = document.getElementById("formAgendamento");
    const btn = document.getElementById("btnSubmit");

    form.addEventListener("submit", function() {
        btn.disabled = true;
    });

});
</script>
{% endblock %}
