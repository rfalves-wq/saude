{% extends 'usuarios/base.html' %}

{% block title %}Dashboard M√©dico{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üë®‚Äç‚öïÔ∏è Dashboard M√©dico</h2>

    <!-- Totais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Pendentes</h5>
                    <p class="card-text">{{ total_pendentes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Atendidos</h5>
                    <p class="card-text">{{ total_atendidos }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Hoje</h5>
                    <p class="card-text">{{ total_dia }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">M√™s</h5>
                    <p class="card-text">{{ total_mes }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Triagens Pendentes -->
    <h3>Triagens Pendentes</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Paciente</th>
                <th>Classifica√ß√£o</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {% for t in triagens %}
            <tr class="{% if t.classificacao_risco == 'Vermelho' %}alerta-vermelho{% endif %}">
                <td>{{ t.paciente.nome }}</td>
                <td>{{ t.classificacao_risco }}</td>
                <td>{{ t.data_triagem|date:"d/m/Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">Nenhuma triagem pendente</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pacientes aguardando t√©cnico aplicar medica√ß√£o -->
    <h3>Medica√ß√£o Pendentes (T√©cnico)</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Paciente</th>
                <th>Prescri√ß√£o</th>
                <th>A√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            {% for a in aguardando_medicacao %}
            <tr>
                <td>{{ a.paciente.nome }}</td>
                <td>{{ a.prescricao|default:"-" }}</td>
                <td><span class="badge bg-warning">Aguardando t√©cnico</span></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">Nenhum paciente aguardando medica√ß√£o</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Medica√ß√£o aplicada (Aguardando decis√£o do m√©dico) -->
    <h3>Medica√ß√£o Aplicada (Aguardando Decis√£o)</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Paciente</th>
                <th>Prescri√ß√£o</th>
                <th>T√©cnico</th>
                <th>Hor√°rio</th>
                <th>A√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            {% for a in medicacao_aplicada %}
            <tr>
                <td>{{ a.paciente.nome }}</td>
                <td>{{ a.prescricao|default:"-" }}</td>
                <td>
                    {% if a.tecnico_aplicou.get_full_name %}
                        {{ a.tecnico_aplicou.get_full_name }}
                    {% else %}
                        {{ a.tecnico_aplicou.username }}
                    {% endif %}
                </td>
                <td>{{ a.horario_medicacao|date:"d/m/Y H:i" }}</td>
                <td>
                    <!-- BOT√ÉO PARA DECIS√ÉO -->
                    <a href="{% url 'decidir_atendimento' a.id %}" class="btn btn-primary btn-sm">
                        Dispensar / Internar
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">Nenhum paciente aguardando decis√£o</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


<!-- ALERTA VERMELHO -->
<style>
.alerta-vermelho {
    animation: piscar 0.8s infinite;
    font-weight: bold;
}
@keyframes piscar {
    0% { background-color: #ffd6d6; }
    50% { background-color: #ff0000; color: white; }
    100% { background-color: #ffd6d6; }
}
</style>

<!-- AUTORELOAD + ALERTA SONORO -->
<script>
setInterval(function(){ location.reload(); }, 5000);

document.addEventListener("DOMContentLoaded", function() {
    let existeVermelho = document.querySelector(".alerta-vermelho");
    if (existeVermelho) {
        setTimeout(function(){
            let audio = new Audio("https://www.soundjay.com/buttons/sounds/beep-07.mp3");
            audio.play().catch(e => console.log("Som bloqueado"));
        }, 500);
    }
});
</script>

{% endblock %}
