{% extends 'usuarios/base.html' %}
{% block content %}

<h2>Atendimento: {{ atendimento.paciente.nome }}</h2>
<p><strong>M√©dico logado:</strong> {{ request.user.get_full_name }}</p>

<hr>

{% if medicacoes_dia %}
<div class="alert alert-info">
    <strong>Medica√ß√µes j√° prescritas hoje:</strong>
    <ul>
        {% for prescricao, medico, hora in medicacoes_dia %}
            <li>{{ prescricao }} ‚Äî <em>{{ medico }}</em> √†s {{ hora|time:"H:i" }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<hr>

<h4>üß™ Solicitar Exame</h4>
<form method="POST" class="mb-4">
    {% csrf_token %}
    <input type="hidden" name="acao" value="novo_exame">

    <div class="row mb-2">
        <div class="col-md-4">
            <select name="tipo_exame" class="form-select" required>
                <option value="">-- Tipo do exame --</option>
                <option value="laboratorio">Laborat√≥rio</option>
                <option value="radiologia">Radiologia</option>
            </select>
        </div>
        <div class="col-md-6">
            <input type="text" name="nome_exame" placeholder="Ex: Hemograma, RX T√≥rax" class="form-control" required>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Solicitar</button>
        </div>
    </div>
</form>

<hr>

<div class="row">
    <!-- Laborat√≥rio -->
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">üß™ Laborat√≥rio</div>
            <div class="card-body">
                {% if exames %}
                <ul class="list-group">
                    {% for exame in exames %}
                        {% if exame.tipo == "laboratorio" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ exame.nome }}
                            {% if exame.status == "pronto" %}
                                <span class="badge bg-success">{{ exame.status|capfirst }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ exame.status|capfirst }}</span>
                            {% endif %}
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-muted">Nenhum exame solicitado.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Radiologia -->
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white">ü©ª Radiologia</div>
            <div class="card-body">
                {% if exames %}
                <ul class="list-group">
                    {% for exame in exames %}
                        {% if exame.tipo == "radiologia" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ exame.nome }}
                            {% if exame.status == "pronto" %}
                                <span class="badge bg-success">{{ exame.status|capfirst }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ exame.status|capfirst }}</span>
                            {% endif %}
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-muted">Nenhum exame solicitado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<hr>

<h4>üìù Salvar Atendimento</h4>
<form method="POST">
    {% csrf_token %}
    <input type="hidden" name="acao" value="salvar_atendimento">

    <div class="mb-3">
        <label>Diagn√≥stico</label>
        <textarea name="diagnostico" class="form-control" rows="3">{{ atendimento.diagnostico }}</textarea>
    </div>

    <div class="mb-3">
        <label>Prescri√ß√£o</label>
        <textarea name="prescricao" class="form-control" rows="3">{{ atendimento.prescricao }}</textarea>
    </div>

    <div class="mb-3">
        <label>Observa√ß√µes</label>
        <textarea name="observacoes" class="form-control" rows="3">{{ atendimento.observacoes }}</textarea>
    </div>

    <div class="mb-3">
        <label>Decis√£o</label>
        <select name="decisao" class="form-select" required>
            <option value="">-- Selecione --</option>
            <option value="dispensar" {% if atendimento.decisao == "dispensar" %}selected{% endif %}>Dispensar</option>
            <option value="medicacao" {% if atendimento.decisao == "medicacao" %}selected{% endif %}>Medica√ß√£o</option>
            <option value="internacao" {% if atendimento.decisao == "internacao" %}selected{% endif %}>Interna√ß√£o</option>
        </select>
    </div>

    <button type="submit" class="btn btn-success">Salvar Atendimento</button>
</form>

{% endblock %}