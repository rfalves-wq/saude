{% extends 'usuarios/base.html' %}

{% block title %}Dashboard M√©dico{% endblock %}

{% block content %}

<!-- USU√ÅRIO LOGADO FIXO NO TOPO DIREITO -->
<div class="usuario-topo d-flex align-items-center p-2 shadow-sm bg-white rounded">
    {% now "H" as hora_atual %}
    <span class="text-muted me-2">
        {% if hora_atual < "12" %}
            Bom dia
        {% elif hora_atual < "18" %}
            Boa tarde
        {% else %}
            Boa noite
        {% endif %},
        <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
    </span>
    <i class="bi bi-person-circle fs-4"></i>
</div>

<div class="container mt-4">
    <!-- T√çTULO -->
    <h2 class="mb-4">üë®‚Äç‚öïÔ∏è Dashboard M√©dico</h2>

    <!-- CARDS PRINCIPAIS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-primary text-center">
                <div class="card-body">
                    <h6>Triagens Pendentes</h6>
                    <h3 class="text-primary">{{ total_pendentes }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success text-center">
                <div class="card-body">
                    <h6>Atendimentos Finalizados</h6>
                    <h3 class="text-success">{{ total_atendidos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info text-center">
                <div class="card-body">
                    <h6>Atendimentos Hoje</h6>
                    <h3 class="text-info">{{ total_dia }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-dark text-center">
                <div class="card-body">
                    <h6>Atendimentos no M√™s</h6>
                    <h3 class="text-dark">{{ total_mes }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- TRIAGENS PENDENTES -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">Triagens Aguardando Atendimento</div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Classifica√ß√£o</th>
                        <th>Data</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in triagens %}
                    <tr class="{% if t.classificacao_risco == 'Vermelho' %}alerta-vermelho{% endif %}">
                        <td>{{ t.paciente.nome }}</td>
                        <td>
                            {% if t.classificacao_risco == "Vermelho" %}
                                <span class="badge bg-danger">Vermelho</span>
                            {% elif t.classificacao_risco == "Laranja" %}
                                <span class="badge" style="background-color: #fd7e14;">Laranja</span>
                            {% elif t.classificacao_risco == "Amarelo" %}
                                <span class="badge bg-warning text-dark">Amarelo</span>
                            {% elif t.classificacao_risco == "Verde" %}
                                <span class="badge bg-success">Verde</span>
                            {% elif t.classificacao_risco == "Azul" %}
                                <span class="badge bg-primary">Azul</span>
                            {% endif %}
                        </td>
                        <td>{{ t.data_triagem|date:"d/m/Y H:i" }}</td>
                        <td>
                            <a href="{% url 'iniciar_atendimento' t.id %}" class="btn btn-sm btn-primary">Atender</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">Nenhuma triagem pendente</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PACIENTES EM MEDICA√á√ÉO / INTERNA√á√ÉO -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">Pacientes em Medica√ß√£o / Interna√ß√£o</div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Prescri√ß√£o / Decis√£o</th>
                        <th>Hor√°rio</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in aguardando_medicacao %}
                    <tr>
                        <td>{{ a.paciente.nome }}</td>
                        <td>{{ a.prescricao|default:"-" }}</td>
                        <td>{{ a.horario_medicacao|date:"d/m/Y H:i"|default:"-" }}</td>
                        <td><span class="badge bg-warning">Aguardando t√©cnico</span></td>
                    </tr>
                    {% endfor %}

                    {% for a in medicacao_aplicada %}
                    <tr>
                        <td>{{ a.paciente.nome }}</td>
                        <td>{{ a.prescricao|default:"-" }}</td>
                        <td>{{ a.horario_medicacao|date:"d/m/Y H:i"|default:"-" }}</td>
                        <td>
                            <a href="{% url 'decidir_atendimento' a.id %}" class="btn btn-primary btn-sm">
                                Dispensar / Internar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                    {% for a in internacoes %}
                    <tr>
                        <td>{{ a.paciente.nome }}</td>
                        <td>{{ a.prescricao|default:"-" }}</td>
                        <td>{{ a.data_atendimento|date:"d/m/Y H:i"|default:"-" }}</td>
                        <td><span class="badge bg-danger">Internado</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

   <!-- ATENDIMENTOS FINALIZADOS -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">Atendimentos Finalizados</div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Paciente</th>
                    <th>Prescri√ß√£o</th>
                    <th>Data Atendimento</th>
                </tr>
            </thead>
            <tbody>
                {% for a in atendimentos_finalizados %}
                <tr>
                    <td>{{ a.paciente.nome }}</td>
                    <td>{{ a.prescricao|default:"-" }}</td>
                    <td>{{ a.data_atendimento|date:"d/m/Y H:i"|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center text-muted">Nenhum atendimento finalizado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>

<!-- ESTILOS -->
<style>
.usuario-topo {
    position: fixed;
    top: 10px;
    right: 20px;
    z-index: 1000;
    background-color: white;
    border-radius: 5px;
    padding: 5px 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
.alerta-vermelho {
    animation: piscar 0.8s infinite;
    font-weight: bold;
}
@keyframes piscar {
    0% { background-color: #ffd6d6; }
    50% { background-color: #ff0000; color: white; }
    100% { background-color: #ffd6d6; }
}
</style>

<!-- AUTORELOAD + ALERTA SONORO -->
<script>
setInterval(function(){ location.reload(); }, 5000);
document.addEventListener("DOMContentLoaded", function() {
    let existeVermelho = document.querySelector(".alerta-vermelho");
    if (existeVermelho) {
        setTimeout(function(){
            let audio = new Audio("https://www.soundjay.com/buttons/sounds/beep-07.mp3");
            audio.play().catch(e => console.log("Som bloqueado"));
        }, 500);
    }
});
</script>

{% endblock %}
